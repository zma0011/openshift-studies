
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.2">
    
    
      
        <title>Knative - Redhat Openshift studies</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.19190aaf.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.24b84193.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#knative" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Redhat Openshift studies" class="md-header-nav__button md-logo" aria-label="Redhat Openshift studies">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Redhat Openshift studies
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Knative
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/jbcodeforce/openshift-studies/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Redhat Openshift studies" class="md-nav__button md-logo" aria-label="Redhat Openshift studies">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Redhat Openshift studies
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jbcodeforce/openshift-studies/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Kubernetes fundamentals
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Kubernetes fundamentals" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Kubernetes fundamentals
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s/k8s-0/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s/k8s-1/" class="md-nav__link">
      Networking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s/k8s-2/" class="md-nav__link">
      Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s/k8s-faq/" class="md-nav__link">
      FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s/k8s-comp/" class="md-nav__link">
      Compendium
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docker/" class="md-nav__link">
      Docker tricks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Openshift
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Openshift" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Openshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cp4i/" class="md-nav__link">
      cp4i
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../faq/" class="md-nav__link">
      FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../oc-cli/" class="md-nav__link">
      oc CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deployment-ex/" class="md-nav__link">
      Deployment examples
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../notes-ocp-training/" class="md-nav__link">
      notes certification
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Knative
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Knative
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#value-propositions" class="md-nav__link">
    Value propositions
  </a>
  
    <nav class="md-nav" aria-label="Value propositions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenges-aws-lambda-that-may-apply-to-knative" class="md-nav__link">
    Challenges (aws lambda that may apply to knative)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-a-service-for-a-given-image" class="md-nav__link">
    Define a service for a given image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#knative-and-quarkus-app" class="md-nav__link">
    Knative and Quarkus app
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#knative-eventing" class="md-nav__link">
    Knative Eventing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-cli-commands" class="md-nav__link">
    Some CLI commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bluegreen-deployment" class="md-nav__link">
    Blue/green deployment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canary-release" class="md-nav__link">
    Canary release
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#knative-eventing_1" class="md-nav__link">
    Knative eventing
  </a>
  
    <nav class="md-nav" aria-label="Knative eventing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#broker-and-trigger" class="md-nav__link">
    Broker and Trigger
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sre/" class="md-nav__link">
      SRE
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../spark-on-os/" class="md-nav__link">
      Operators (with Spark)
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../opendatahub/" class="md-nav__link">
      Open Data Hub
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../istio/readme/" class="md-nav__link">
      Istio
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ansible/" class="md-nav__link">
      Ansible
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../odo-appsody/" class="md-nav__link">
      ODO - Appsody Summary
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../compendium/" class="md-nav__link">
      Compendium
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#value-propositions" class="md-nav__link">
    Value propositions
  </a>
  
    <nav class="md-nav" aria-label="Value propositions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenges-aws-lambda-that-may-apply-to-knative" class="md-nav__link">
    Challenges (aws lambda that may apply to knative)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-a-service-for-a-given-image" class="md-nav__link">
    Define a service for a given image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#knative-and-quarkus-app" class="md-nav__link">
    Knative and Quarkus app
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#knative-eventing" class="md-nav__link">
    Knative Eventing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-cli-commands" class="md-nav__link">
    Some CLI commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bluegreen-deployment" class="md-nav__link">
    Blue/green deployment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canary-release" class="md-nav__link">
    Canary release
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#knative-eventing_1" class="md-nav__link">
    Knative eventing
  </a>
  
    <nav class="md-nav" aria-label="Knative eventing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#broker-and-trigger" class="md-nav__link">
    Broker and Trigger
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jbcodeforce/openshift-studies/edit/master/docs/knative.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="knative">Knative</h1>
<p><a href="https://knative.dev/">Knative</a> is Kubernetes based platform to develop serverless. Major value proposition is a simplified deployment syntax with automated scale-to-zero and scale-out based on HTTP load. Other interesting characteristics:</p>
<ul>
<li><strong>adjust the traffic distribution</strong> amongst the service revisions, to support blue/green deployment and canary release</li>
<li>able to <strong>scale to zero</strong>: After a defined time of idleness (the so called stable-window) a revision is considered inactive. Now, all routes pointing to the now inactive revision will be pointed to the so-called activator. By default the scale-to-zero-grace-period is 30s, and the stable-window is 60s.</li>
<li><strong>auto-scaling</strong>: By default Knative Serving allows 100 concurrent requests into a pod. This is defined by the container-concurrency-target-default setting in the configmap config-autoscaler in the knative-serving namespace.</li>
</ul>
<p>Knative consists of the following components:</p>
<ul>
<li>Eventing - Management and delivery of events</li>
<li>Serving - Request-driven compute that can scale to zero</li>
</ul>
<p><a href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial/index.html">Redhat knative cookbook</a>.</p>
<h2 id="value-propositions">Value propositions</h2>
<p>Like any serverless (AWS lambda, openwhisk..) the benefits are:</p>
<ul>
<li>instantly spin up enough server resources to handle tens of thousands of incoming requests</li>
<li>more expensive on compute time, but cost zero after</li>
<li>spin up a completely separate version of the site to do some prototyping, no need to worry about forgetting a test running forever</li>
<li>No Kubernetes configurations, no load balancers, no auto scaling rules</li>
</ul>
<h3 id="challenges-aws-lambda-that-may-apply-to-knative">Challenges (aws lambda that may apply to knative)</h3>
<ul>
<li>web socket support, SMTP session</li>
<li>With AWS no control of the OS, so difficult to bring your libraries. Knative as container fixes this.</li>
<li>AWS: functions with less TAM have slower CPU speed. This can swing a lot between 5ms to 500ms response time. Charged by 100ms increment</li>
<li>Using SPA app like React or Angular, the page will be downloaded from a Content CDN server, which leads to have a delay between this web server and the function. If you want &lt;50ms response times, then hosting your backend behind API Gateway is not for function.</li>
<li>Need non serverless services like VPC, NAT gateways to access other service like storage. </li>
<li>to get a granular record of what Lambdas are running, how many times and for how long, measurement and Logging products are not serverless, so cost a lot. Specially as you may not control the information sent to the logger (Cloudwatch).</li>
<li>Idempotence: AWS Lambda, can execute the same requests more than once. Which will generate multiple records written into the DB. This is due to retries on errors, and event source set at least once delivery.
Use request identifiers to implement idempotent Lambda functions that do not break if a function invocation needs to be retried. Make sure to pass the original request id to all subsequent calls. The original request id is generated as early as possible in the chain. If possible on the client side. Avoid generating your own ids.</li>
<li>Time limit on execution to prevent deadlocked function. Difficult to see those functions as they disappear.</li>
<li>COLD start: if your function hasn’t been run in a while, a pending request needs to wait for it to be initialized before it can be served: 3 to 5 seconds. nothing the end-user touches could be hosted on Lambda after all</li>
<li>view Lambda mainly in terms of what it can do as a high-end parallel architecture </li>
</ul>
<h2 id="getting-started">Getting started</h2>
<ul>
<li>Install Knative CLI with <a href="https://github.com/knative/homebrew-client">brew</a>. It will be accessible via <code>kn</code></li>
<li>Or use Knative CLI running in docker, <a href="https://knative.dev/docs/install/install-kn/#kn-container-images">see doc here</a></li>
<li>
<p>To prepare OpenShift <a href="https://docs.openshift.com/container-platform/4.3/serverless/installing_serverless/installing-openshift-serverless.html">see the serverless install instructions</a>. </p>
<ul>
<li>The minimum requirement to use OpenShift Serverless is a cluster with 10 CPUs and 40GB memory. Use operator hub to install Knative serving and eventing servers and brokers. </li>
<li>OpenShift Serverless Operator eventually shows up and its Status ultimately resolves to InstallSucceeded in the openshift-operators namespace.</li>
<li>Creating the knative-serving namespace: <code>oc create namespace knative-serving</code>, and then within the project itself, create an instance. </li>
<li>Verify the conditions: <code>oc get knativeserving.operator.knative.dev/knative-serving -n knative-serving --template='{{range .status.conditions}}{{printf "%s=%s\n" .type .status}}{{end}}'</code>
You should get:</li>
</ul>
<p><div class="highlight"><pre><span></span><code>DependenciesInstalled=True
DeploymentsAvailable=True
InstallSucceeded=True
Ready=True
</code></pre></div>
* With a yaml file: and <code>oc apply</code> it.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">operator.knative.dev/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">KnativeServing</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">knative-serving</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">knative-serving</span>
  <span class="nt">spec</span><span class="p">:</span>
    <span class="nt">high-availability</span><span class="p">:</span>
      <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
</code></pre></div>
<p>*We can do the same for knative-eventing: create a namespace and then an instance using the serverless operator. 
* Verify with: <code>oc get knativeeventing.operator.knative.dev/knative-eventing -n knative-eventing --template='{{range .status.conditions}}{{printf "%s=%s\n" .type .status}}{{end}}'</code></p>
</li>
</ul>
<h3 id="define-a-service-for-a-given-image">Define a service for a given image</h3>
<p>oc apply the following definition:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">serving.knative.dev/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">greeter</span>
<span class="nt">spec</span><span class="p">:</span>
 <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">greeter-v2</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/rhdevelopers/knative-tutorial-greeter:quarkus</span>
        <span class="nt">livenessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/healthz</span>
        <span class="nt">readinessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/healthz</span>
</code></pre></div>
<p>Get the detail of the configuration: <code>oc get configurations.serving.knative.dev greeter</code></p>
<h3 id="knative-and-quarkus-app">Knative and Quarkus app</h3>
<p>Be sure to have the kubernetes or openshit plugin: <code>./mvnw quarkus:add-extension -Dextensions="openshift"</code>
Add the following property:</p>
<div class="highlight"><pre><span></span><code><span class="na">quarkus.kubernetes.deployment-target</span><span class="o">=</span><span class="s">knative</span>
</code></pre></div>
<p>When doing <code>mvn package</code> a knative.yaml file is created under target/kubernetes</p>
<p>Other example of creating deployment:</p>
<div class="highlight"><pre><span></span><code>mvn -Dcontainer.registry.url=&#39;https://index.docker.io/v1/&#39; \
&gt; -Dcontainer.registry.user=&#39;jbcodefore&#39; \
&gt; -Dcontainer.registry.password=&#39;XXXXXXXYYYYYYYZZZZZZZZ&#39; \
&gt; -Dgit.source.revision=&#39;master&#39; \
&gt; -Dgit.source.repo.url=&#39;https://github.com/quarkusio/quarkus-quickstarts.git&#39; \
&gt; -Dapp.container.image=&#39;quay.io/jbcodefore/quarkus-greetings&#39; package
</code></pre></div>
<p>This command creates the resource files in <code>target/kubernetes</code> directory</p>
<p>Deploy the service <code>oc apply --recursive --filename target/kubernetes/</code></p>
<p>Some RedHat <a href="https://developers.redhat.com/blog/2019/04/09/from-zero-to-quarkus-and-knative-the-easy-way/">article</a>.</p>
<h2 id="knative-eventing">Knative Eventing</h2>
<h2 id="some-cli-commands">Some CLI commands</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># get revisions for a service</span>
oc get rev --selector<span class="o">=</span>serving.knative.dev/service<span class="o">=</span>greeter --sort-by<span class="o">=</span><span class="s2">&quot;{.metadata.creationTimestamp}&quot;</span>
oc delete services.serving.knative.dev greeter
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># create a service from image</span>
kn service create greeter --image quay.io/rhdevelopers/knative-tutorial-greeter:quarkus
<span class="c1"># create a revision</span>
kn service update greeter --env <span class="s2">&quot;MESSAGE_PREFIX=Namaste&quot;</span>
kn service describe greeter
kn service delete greeter
<span class="c1"># get revisions</span>
kn revision list
kn revision describe greeter-xhwyt-1 

<span class="c1"># route</span>
kn route list
</code></pre></div>
<h2 id="bluegreen-deployment">Blue/green deployment</h2>
<p>Knative offers a simple way of switching 100% of the traffic from one Knative service revision (blue) to another newly rolled out revision (green).
By default new revision receives 100% of the new traffic. To rollback we need to create a yaml with the template.metadata.name to the expected revision and add the following spec.traffic</p>
<div class="highlight"><pre><span></span><code> <span class="nt">traffic</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
      <span class="nt">revisionName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">greeter-v1</span>
      <span class="nt">percent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
    <span class="p p-Indicator">-</span> <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v2</span>
      <span class="nt">revisionName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">greeter-v2</span>
      <span class="nt">percent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="p p-Indicator">-</span> <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
      <span class="nt">latestRevision</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">percent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</code></pre></div>
<h2 id="canary-release">Canary release</h2>
<p>Knative allows you to split the traffic between revisions</p>
<div class="highlight"><pre><span></span><code> <span class="nt">traffic</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
      <span class="nt">revisionName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">greeter-v1</span>
      <span class="nt">percent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="p p-Indicator">-</span> <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v2</span>
      <span class="nt">revisionName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">greeter-v2</span>
      <span class="nt">percent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span>
    <span class="p p-Indicator">-</span> <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
      <span class="nt">latestRevision</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">percent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</code></pre></div>
<h2 id="knative-eventing_1">Knative eventing</h2>
<p>There are three primary usage patterns with Knative Eventing:</p>
<ol>
<li><strong>Source to Sink</strong>: It provides single Sink — that is, event receiving service --, with no queuing, back-pressure, and filtering. The Source to Service does not support replies, which means the response from the Sink service is ignored</li>
<li><strong>Channel and subscription</strong>: the Knative Eventing system defines a Channel, which can connect to various backends such as In-Memory, Kafka and GCP PubSub for sourcing the events. Each Channel can have one or more subscribers in the form of Sink services<br />
<img alt="1" src="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial-eventing/_images/channels-subs.png" /></li>
<li><strong>Broker and Trigger</strong>:  supports filtering of events so subscribers specify interest on certain set of messages that flows into the Broker. For each Broker, Knative Eventing will implicitly create a Knative Eventing Channel. The Trigger gets itself subscribed to the Broker and applies the filter on the messages on its subscribed broker. The filters are applied on the on the Cloud Event attributes of the messages, before delivering it to the interested Sink Services(subscribers).</li>
</ol>
<p><img alt="2" src="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial-eventing/_images/brokers-triggers.png" /></p>
<p>To make a project using knative eventing label the namespace with: <code>kubectl label namespace jbsandbox knative-eventing-injection=enabled</code>. This will start the filter and ingress pods.</p>
<h3 id="broker-and-trigger">Broker and Trigger</h3>
<p>See <a href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial-eventing/eventing-trigger-broker.html">this tutorial</a> for basics trigger and services. This tutorial defines filtering on CloudEvent type named greeting so the two different services can subscribe to.  </p>
<p>When eventing is set the filter and ingress pods are started. To get the address of the broker url: <code>oc get broker default -o jsonpath='{.status.address.url}'</code></p>
<p>Then the approach is to create different sinks, define triggers for each sink on what kind of event attribute to subscribe too, so filtering can occur. The sink will respond depending of the cloud event 'type' attribute for example.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>Source of knowledge <a href="https://knative.dev/docs/serving/debugging-application-issues/">Debugging issues with your application</a>.</p>
<ul>
<li>Revision failed</li>
</ul>
<div class="highlight"><pre><span></span><code>oc get configurations.serving.knative.dev item-kafka-producer
NAME                  LATESTCREATED               LATESTREADY   READY     REASON
item-kafka-producer   item-kafka-producer-65kbv                 False     RevisionFailed
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../notes-ocp-training/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                notes certification
              </div>
            </div>
          </a>
        
        
          <a href="../sre/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                SRE
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../assets/javascripts/bundle.c1ccee15.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>