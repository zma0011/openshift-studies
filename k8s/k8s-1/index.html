
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.2">
    
    
      
        <title>Networking - Redhat Openshift studies</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.19190aaf.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.24b84193.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#networking" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Redhat Openshift studies" class="md-header-nav__button md-logo" aria-label="Redhat Openshift studies">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Redhat Openshift studies
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Networking
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/jbcodeforce/openshift-studies/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Redhat Openshift studies" class="md-nav__button md-logo" aria-label="Redhat Openshift studies">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Redhat Openshift studies
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jbcodeforce/openshift-studies/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Kubernetes fundamentals
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Kubernetes fundamentals" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Kubernetes fundamentals
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s-0/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Networking
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Networking
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker-networking" class="md-nav__link">
    Docker networking
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-networking" class="md-nav__link">
    Kubernetes networking
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress" class="md-nav__link">
    Ingress
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-discovery" class="md-nav__link">
    Service Discovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-dns" class="md-nav__link">
    Kubernetes DNS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#virtual-private-cloud" class="md-nav__link">
    Virtual Private Cloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security" class="md-nav__link">
    Security
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s-2/" class="md-nav__link">
      Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s-faq/" class="md-nav__link">
      FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../k8s-comp/" class="md-nav__link">
      Compendium
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../docker/" class="md-nav__link">
      Docker tricks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Openshift
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Openshift" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Openshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cp4i/" class="md-nav__link">
      cp4i
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../faq/" class="md-nav__link">
      FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../oc-cli/" class="md-nav__link">
      oc CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployment-ex/" class="md-nav__link">
      Deployment examples
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes-ocp-training/" class="md-nav__link">
      notes certification
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../knative/" class="md-nav__link">
      Knative
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../sre/" class="md-nav__link">
      SRE
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../spark-on-os/" class="md-nav__link">
      Operators (with Spark)
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../opendatahub/" class="md-nav__link">
      Open Data Hub
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../istio/readme/" class="md-nav__link">
      Istio
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../ansible/" class="md-nav__link">
      Ansible
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../odo-appsody/" class="md-nav__link">
      ODO - Appsody Summary
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../compendium/" class="md-nav__link">
      Compendium
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker-networking" class="md-nav__link">
    Docker networking
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-networking" class="md-nav__link">
    Kubernetes networking
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress" class="md-nav__link">
    Ingress
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-discovery" class="md-nav__link">
    Service Discovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-dns" class="md-nav__link">
    Kubernetes DNS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#virtual-private-cloud" class="md-nav__link">
    Virtual Private Cloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security" class="md-nav__link">
    Security
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jbcodeforce/openshift-studies/edit/master/docs/k8s/k8s-1.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="networking">Networking</h1>
<p>With kubernetes it is important to understand how the networking, load balancing, security and service communication, work. In multi-host deployment, you need to understand how containers are communicating within a host and between different hosts.</p>
<p>The Cloud Native Computing Foundation (CNCF) sponsors the Container Networking Interface (CNI) open source project. The CNI project aims to standardize the network interface for containers in cloud native environments, such as Kubernetes.</p>
<p>Docker uses the CNI project to implement a software-defined network (SDN) for containers on each host.</p>
<h2 id="docker-networking">Docker networking</h2>
<p>With Docker there are four networking mode approaches: <code>bridge, host, container or no networking</code> mode.
With <code>bridge</code> mode docker daemon creates a <code>docker0</code> virtual ethernet bridge to forward packets to any interface attached to it. All containers running on the host are attached to this bridge, and peer attached to the container <code>eth0</code> interface, They got an IP address and are part of a subnet. The default bridge network is present on all Docker hosts. If you do not specify a different network, new containers are automatically connected to the default bridge network:</p>
<p><img alt="" src="../images/docker-network.png" />  </p>
<p>Containers are isolated from the host network. Docker containers can talk to other containers only if they are on the same machine. Because of network isolation, a container in one SDN can have the same IP address as a container in a different SDN.</p>
<p>With <code>Host mode</code>  (<code>docker run -d --net=host  yourimagehere</code>) the containers share IP and namespace, and you need to take care of the port numbering schema. There is no routing overhead, but this approach exposes the container to the network.  </p>
<p>Docker does not support automatic service discovery on the default bridge network. If you want containers to be able to resolve IP addresses by container name, you should use user-defined networks instead.</p>
<p>Exposing ports in a Dockerfile is a way of documenting which ports are used, but does not actually map or open any ports. When starting the container the exposed port is published. So for previous figure, we have:</p>
<div class="highlight"><pre><span></span><code>$ docker run –d  -p 8081:8080 imagename
</code></pre></div>
<blockquote>
<p>When using <code>nodePort</code> a dynamic published port number is generated by kubernetes.</p>
</blockquote>
<p>When a pod contains two containers, they run their own <code>cgroup</code>, but shares IPC, Network, and UTC (hostname) namespaces. This can be proven using the following commands:</p>
<div class="highlight"><pre><span></span><code>oc exec -it my-two-container-pod -c side-car -- /bin/sh
ip address
netstat -ntlp
hostname
</code></pre></div>
<h2 id="kubernetes-networking">Kubernetes networking</h2>
<p>Kubernetes uses the <code>container mode</code>, where other containers share the same IP address as a previously created containers within the pod: it is set at the pod scope level. It requires each pod to have an IP in a flat networking namespace with full connectivity to other nodes and pods across the network.</p>
<p>The Pod IP address is allocated by Calico IPAM and the networking interface definition within the pod and host is done by Calico CNI plugin. The following diagram illustrates the process:</p>
<p><img alt="" src="../images/cni-pod-net.png" /></p>
<p>The following commands help to see these IP schema:</p>
<div class="highlight"><pre><span></span><code>$ kubectl get node -o wide
NAME           STATUS  VERSION          EXTERNAL-IP  OS-IMAGE             KERNEL-VERSION      
172.16.40.137  Ready   v1.10.0+icp-ee   &lt;none&gt;       Ubuntu 16.04.3 LTS   4.4.0-112-generic   
172.16.40.139  Ready   v1.10.0+icp-ee   &lt;none&gt;       Ubuntu 16.04.3 LTS   4.4.0-112-generic  
# The 172.16.40.137 is the IP address of the HOST
$ kubectl describe node 172.16.40.137
# but ssh to the host/node and looking at the interface, we can see the ethernet and docker interfaces:
$ ifconfig
ens160    Link encap:Ethernet  HWaddr 00:50:56:a5:cf:34  
          inet addr:172.16.40.137  Bcast:172.16.255.255  Mask:255.255.0.0

docker0   Link encap:Ethernet  HWaddr 02:42:73:1c:72:ca  
           inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0
</code></pre></div>
<p>This IP-per-pod model yields a backward-compatible way for you to treat a pod almost identically to a VM or a physical host, in the context of naming, service discovery, or port allocations. Containers inside a pod can communicate with each other using <code>localhost</code>.  </p>
<p>Kubernetes using Calico as Container Network Interface is configured with a large flat subnet (e.g. 172.30.0.0/16) that is considered internal application traffic inside of the cluster. Each worker node in the Kubernetes cluster is assigned one or more non-overlapping slices of this network, coordinated by the Kubernetes master node. When a container is created in the cluster, it gets assigned to a worker node and is given an IP address from the slice of the subnet for the worker node.</p>
<p><img alt="" src="../images/net-pod-host.png" /></p>
<p>Kube-proxy intercepts and controls where to forward the traffic, internal to the node, or to another worker node running the destination pod, or outside of the cluster.   </p>
<p>For inter-pod networking as pod has its own routable IP address there is no need for proxies or NAT. Except that with Kubernetes, services use a completely separate set of IP addresses. The IP addresses are not known by Calico, and are not directly routable. However, they are still reachable by pods since the kube-proxy performs NAT on those IPs (NAT from svc IP@ to Pod IP @).</p>
<p>Any pod can communicate with any another pod using its assigned IP address, even if it’s on a different worker node.</p>
<p>K8s Services are used as virtual IP address (it is k8s concept), that are discovered via DNS and allow clients to reliably discover and connect to containers.</p>
<h3 id="services">Services</h3>
<ul>
<li>
<p><strong>Services group</strong> a set of pods and provide network connection to these pods for other services in the cluster without exposing the actual private IP address of each pod. https://kubernetes.io/docs/concepts/services-networking/service/</p>
</li>
<li>
<p>A <strong>Service</strong> in Kubernetes is an abstraction which defines a logical set of Pods and a policy by which to access them. Services enable a loose coupling between dependent Pods.</p>
</li>
</ul>
<p>As Pods are ephemeral in nature, resources like IP addresses allocated to it cannot be static. As an example the pods running for the BFF apps are:
  <div class="highlight"><pre><span></span><code>$ kubectl get pods -n greencompute -o wide
NAME                                                  READY     STATUS    RESTARTS   AGE       IP                NODE
gc-caseportal-bc-caseportal-app-698f98d787-56qz5      1/1       Running   0          5d     192.168.130.74   172.16.40.138
gc-caseportal-bc-caseportal-app-698f98d787-bhl5f      1/1       Running   0          5d     192.168.223.17   172.16.40.137
</code></pre></div>
  The 192.168.x.x is a flat, cluster wide, address space. As illustrated in the figure below:</p>
<p><img alt="" src="../images/pod-proxy-svc.png" /></p>
<p>The command shows the <code>eth0</code> interface in the container is map to this IP address.
  ```
  $ kubectl exec gc-caseportal-bc-caseportal-app-698f98d787-56qz5 -- ip addr
  ....
4: eth0@if16: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP
    link/ether c2:74:08:4a:69:3f brd ff:ff:ff:ff:ff:ff
    inet 192.168.130.74/32 scope global eth0</p>
<div class="highlight"><pre><span></span><code>You can use Kubernetes services to make an app available to other pods inside the cluster or to expose an app to the internet by abstracting the dynamic IP address assignment. The yaml below creates the casewebportal-svc: `kubectl apply -f svc.yml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: casewebportal-svc
  namespace: greencompute
  labels:
    app: casewebportal
spec:
  type: NodePort
  ports:
  - port: 6100
    targetPort: 6100
    protocol: TCP
    name: http
  selector:
    app: casewebportal
</code></pre></div>
<p>By default, each Service also gets an IP address (known as <strong>ClusterIP</strong>), which is routable only inside the cluster. The target port 6100 is visible as 31560 on the node</p>
<div class="highlight"><pre><span></span><code>$ kubectl get  svc
NAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
casewebportal-svc                    NodePort    10.10.10.197   &lt;none&gt;        6100:31560/TCP   6d
</code></pre></div>
<p>A Service is backed by a group of Pods. These Pods are exposed through endpoints. The command below displays the endpoints. The port number stays the same on all worker nodes and event Proxy node.
<div class="highlight"><pre><span></span><code>$ kubectl  get ep casewebportal-svc
NAME                ENDPOINTS                                 AGE
casewebportal-svc   192.168.130.74:6100,192.168.223.17:6100   6d
</code></pre></div>
When a Pod runs on a Node, the kubelet adds a set of environment variables for each active Service. You can see those variables with the command:</p>
<div class="highlight"><pre><span></span><code>$ kubectl exec gc-caseportal-bc-caseportal-app-698f98d787-56qz5 -- printenv
</code></pre></div>
<p>A Service does the load balancing while selecting the Pods for forwarding the data/traffic. It uses the label and label selector to get access to the pods.</p>
<p>Kubernetes offers a <strong>DNS cluster addon</strong> Service that automatically assigns dns names to other Services:
<div class="highlight"><pre><span></span><code>$ kubectl get services kube-dns --namespace=kube-system
NAME       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE
kube-dns   ClusterIP   10.10.10.10   &lt;none&gt;        53/UDP,53/TCP   10d
</code></pre></div>
So we can do a <code>nslookup</code> within any pod to assess where to find the service:</p>
<p><div class="highlight"><pre><span></span><code>$ kubectl exec gc-caseportal-bc-caseportal-app-698f98d787-56qz5 -- nslookup casewebportal-svc

nslookup: can&#39;t resolve &#39;(null)&#39;: Name does not resolve
Name:      casewebportal-svc
Address 1: 10.10.10.197 casewebportal-svc.greencompute.svc.cluster.local
</code></pre></div>
You can access ClusterIP service using the cluster local proxy:
  * Start the kubernetes local proxy: <code>kubectl proxy --port=8080</code>
  * Access the service via url like: http://localhost:8080/api/v1/proxy/namespaces/NAMESPACE/services/SERVICE-NAME:PORT-NAME/</p>
<p>We can define a service without selectors, so no Endpoint object will be created, and we can map to your endpoint via the subset.addresses.ip spec. This is useful to abstract other kinds of backend component like DB server, a service in another namespace...</p>
<p>The <strong>NodePort</strong> ServiceType is useful when we want to make the services accessible from the external world. BUT if the IP address of the VM change you need to take care of this problem in your client code.
The end-user connects to the Worker Nodes on the specified port, which forwards the traffic to the applications running inside the cluster. To access the application from the external world, administrators can configure a reverse proxy outside the Kubernetes cluster and map the specific endpoint to the respective port on the Worker Nodes. See this article:
https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0</p>
<p>Using NGINX server as front end and load balancer, the routing can be done outside the cluster. The following conf file an be deployed in the /etc/nginx/conf.d folder and will help to load balance between two pods:</p>
<div class="highlight"><pre><span></span><code>upstream caseportal {
  server 172.16.40.137:31560;
  server 172.16.40.138:31560;
}
server {
  location / {
  proxy_pass http://caseportal;
  }
}
</code></pre></div>
<p>Alternate is to use <strong>LoadBalancer</strong> service.
With the LoadBalancer ServiceType: NodePort and ClusterIP Services are automatically created, and the external load balancer will route to them. The Services are exposed at a static port on each Worker Node. The Service is exposed externally using the underlying Cloud provider's load balancer feature. If you want to directly expose a service, this is the default method. All traffic on the port you specify will be forwarded to the service.</p>
<p>Finally,the last model is by using ingress.</p>
<h3 id="ingress">Ingress</h3>
<p>Ingress is another method (from LoadBalancer and NodePort) we can use to access our applications from the external world. It works at layer 7 traffic. The Kubernetes cluster must have an Ingress controller deployed to be able to create Ingress resources. The Ingress controller is deployed as a Docker container. Its Docker image contains a load balancer like NGInx and a controller daemon. The controller daemon receives the desired Ingress configuration from Kubernetes, it generates an NGInx configuration file and restarts the load balancer process for changes to take effect. Ingress controller is a load balancer managed by Kubernetes.
Ingress helps to decouple the routing rules from the application, we can then update our application without worrying about its external access. With Ingress, users don't connect directly to a Service. Users reach the Ingress endpoint, and, from there, the request is forwarded to the respective Service.
You can define one ingress for all the component of your application you want to expose to external world.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web-ingress</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">rules</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myservice.mydomain.com</span>
    <span class="nt">http</span><span class="p">:</span>
      <span class="nt">paths</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/dashboardbff</span>
      <span class="p p-Indicator">-</span> <span class="nt">backend</span><span class="p">:</span>
          <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dashboard-bff-svc</span>
          <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
  <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">green.myweb.com</span>
    <span class="nt">http</span><span class="p">:</span>
      <span class="nt">paths</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">backend</span><span class="p">:</span>
          <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">green-service</span>
          <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<h3 id="service-discovery">Service Discovery</h3>
<p>As soon as the Pod starts on any Worker Node, the <strong>kubelet</strong> daemon running on that node adds a set of environment variables in the Pod for all active Services. Be careful while ordering Services, as the Pods will not have the environment variables set for Services which are created after the Pods are created.
The DNS add-on, creates a DNS record for each normal Service and its format is like <code>my-svc.my-namespace.svc.cluster.local</code> within the same namespace can reach to other services with just their name.</p>
<p>The following diagram groups all those networking concepts to illustrates, Ingress, service, kube-proxy and label selectors:</p>
<p><img alt="" src="../images/ingress-svc-proxy.png" />  </p>
<h3 id="kubernetes-dns">Kubernetes DNS</h3>
<p>Kubelets resolve hostnames for pods through a Service named <code>kube-dns</code>. kube-dns runs as a pod in the kube-system namespace. Every Service that is created is automatically assigned a DNS name. By default, this hostname is <code>ServiceName.Namespace</code>. All Services that are in the same namespace may omit <code>Namespace</code> and just use <code>ServiceName</code>. Here is an example:</p>
<p>To understand the default kubernetes DNS pod, you can run</p>
<div class="highlight"><pre><span></span><code>k describe pod kube-dns-nw8gf -n kube-system
</code></pre></div>
<p>It watches the Kubernetes master for changes in Services and Endpoints, and maintains in-memory lookup structures to serve DNS requests. It has a static address, and kubelet passes DNS to each container with the --cluster-dns=<dns-service-ip> flag. The default domain is <code>cluster.local</code>.</p>
<h2 id="virtual-private-cloud">Virtual Private Cloud</h2>
<p>VPC delivers networking functions for cloud deployments in logically isolated segments using Software Defined Networking.</p>
<p>It is a virtual networking platform tied to a tenant account. It provides logical isolation within the same tenant and other tenants. 
Zones are created using high bandwidth and low latency connections (3 ms). 
A VPC spans multiple zones at each region for high availability. It does not span regions. With VPC, operators can customize network topologies, sizes, IP addressing without NAT or tunnels. It supports bring your own IP address plan. The security controls are done at the subnet and server level. Some important features:</p>
<ul>
<li>A region has three or more zones. </li>
<li>Multi-zone regions is designed to support enterprise workloads accross application, data, security and solution domains.</li>
<li>Availability zone is an independent fault domains that do not share physical infrastructure. It has a latency requirement of &lt;500 micro second intra-zone and &lt;2 ms inter-zone.</li>
</ul>
<h2 id="security">Security</h2>
<p>With kubernetes deployed internally, companies have control over their physical environment, network, operating system patches, access to authentication and authorization internal registry. They control data access, access to administration console for the platform and the workload deployed. </p>
<p>As part of security is the Identity and access management to control access to resource and connection protocol like <a href="https://openid.net/what-is-openid">OpenID</a>. A team is a logical grouping of resources, users, and user groups. Teams can be restricted to all resources within a namespace.  Access control gateway enforces role-based access control (RBAC) for all registered services.</p>
<p>Network segmentation to provide isolation, using DMZ VLAN for specific workload, so deploying cluster in DMZ. And use VLAN to segment the physical network, subnets, clusters and namespaces to add more segmentation.   </p>
<p><img alt="" src="../images/net-segment.png" />   </p>
<p>Segmentation will depend of the application requirements.
For securing kubernetes network control, you will have Edge nodes that are worker nodes with only ingress workloads and network policies.  Traffic reaches application through private network. Backend services may not have access from public network. K8s <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">network policy</a> specifies how pods can communicate with each other, and <a href="https://www.projectcalico.org/">Calico</a>, the IP based networking, implements the policies (rule per IP addresses). Rules are ORe'ed, if any ingress /egress rule matches connection is allowed. Their are scoped at namespace level.</p>
<p>We can isolate application using labels. THe srv1 backend can be access only from the frontend</p>
<div class="highlight"><pre><span></span><code>kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: backend-allow
spec:
  podSelector:
    matchLabels:
      app: Srv1
      Tier: backend
  ingress:
  - from:
      - podSelector:
          matchLabels:
            app: Srv1
            Tier: frontend
</code></pre></div>
<p>and the db backend can only be access from the srv1 backend.</p>
<div class="highlight"><pre><span></span><code>kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: db-allow
spec:
  podSelector:
    matchLabels:
      app: Srv1
      Tier: db
  ingress:
  - from:
      - podSelector:
          matchLabels:
            app: Srv1
            Tier: backend
</code></pre></div>
<p><a href="../k8s-faq/">&gt;&gt; NEXT</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../k8s-0/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Introduction
              </div>
            </div>
          </a>
        
        
          <a href="../k8s-2/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Security
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../../assets/javascripts/bundle.c1ccee15.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>